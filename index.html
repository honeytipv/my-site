<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>의견센터 with EmailJS 인증</title>
<style>
  /* 기본 초기화 및 스타일 */
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: "Noto Sans KR", sans-serif;
    overflow: hidden; /* 기본은 스크롤 차단 */
  }
  /* 동의 전체 화면 */
  #consentScreen {
    position: fixed;
    top:0; left:0; width: 100vw; height: 100vh;
    background: #fff;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  #consentScreen h2 {
    margin-bottom: 20px;
    font-weight: 700;
    font-size: 1.5rem;
    color: #333;
  }
  #consentScreen p {
    margin: 0 0 30px 0;
    font-size: 1rem;
    color: #555;
    max-width: 320px;
    text-align: center;
    line-height: 1.4;
  }
  #consentBtn {
    background-color: #004aad;
    color: white;
    border: none;
    padding: 12px 36px;
    font-size: 1.1rem;
    font-weight: 700;
    border-radius: 4px;
    cursor: pointer;
  }
  #consentBtn:hover {
    background-color: #003380;
  }

  /* 본문 및 검색창 숨김 상태 */
  #mainContent {
    display: none; /* 동의 후 보임 */
    height: 100vh;
    overflow-y: auto;
  }

  /* 의견센터 모달 배경 전체 화면 */
  #feedbackModal {
    position: fixed;
    top:0; left:0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.5);
    display: none; /* 기본 닫힘 */
    justify-content: center;
    align-items: center;
    z-index: 9998;
  }

  /* 모달 컨텐츠 */
  #feedbackModal .modal-content {
    background: white;
    width: 90vw;
    max-width: 480px;
    max-height: 90vh;
    padding: 24px;
    box-sizing: border-box;
    border-radius: 8px;
    overflow-y: auto;
    position: relative;
  }

  /* 닫기 버튼 없음 (요청대로) */

  /* 입력폼 */
  label {
    display: block;
    margin: 12px 0 6px;
    font-weight: 600;
  }
  input[type=email], textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 10px;
    font-size: 1rem;
    border: 1px solid #aaa;
    border-radius: 4px;
  }
  textarea {
    resize: vertical;
    min-height: 100px;
  }
  button {
    margin-top: 20px;
    padding: 12px 24px;
    font-size: 1.1rem;
    background-color: #004aad;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 700;
  }
  button:disabled {
    background-color: #999;
    cursor: not-allowed;
  }

  /* 이메일 인증 영역 */
  #emailAuthSection {
    margin-bottom: 20px;
  }
  #otpSection {
    margin-top: 12px;
  }

  /* 성공 / 에러 메시지 */
  .message {
    margin-top: 8px;
    font-size: 0.9rem;
  }
  .message.success {
    color: green;
  }
  .message.error {
    color: red;
  }

</style>
</head>
<body>

<!-- 동의 전체 화면 -->
<div id="consentScreen">
  <h2>개인정보 처리 및 서비스 이용 동의</h2>
  <p>본 웹사이트는 이메일 인증을 통해 의견을 수집하며, 이메일은 인증 목적으로만 사용됩니다.<br>
  아래 버튼을 눌러 동의하셔야 서비스를 이용할 수 있습니다.</p>
  <button id="consentBtn">동의합니다</button>
</div>

<!-- 메인 콘텐츠 (검색창 등) -->
<div id="mainContent">
  <header style="padding: 10px; background:#eee; text-align:center;">
    <h1>검색창 및 메인 콘텐츠</h1>
    <button id="openFeedbackBtn" style="font-size:1rem; padding:8px 16px; cursor:pointer;">의견센터 열기</button>
  </header>
  <section style="padding: 20px;">
    <p>여기에 검색창과 주요 콘텐츠가 들어갑니다.</p>
  </section>
</div>

<!-- 의견센터 모달 -->
<div id="feedbackModal" aria-modal="true" role="dialog" aria-labelledby="feedbackTitle" aria-describedby="feedbackDesc">
  <div class="modal-content">
    <h2 id="feedbackTitle">의견 보내기</h2>
    <div id="emailAuthSection">
      <label for="emailInput">이메일 주소</label>
      <input type="email" id="emailInput" placeholder="example@domain.com" autocomplete="email" />
      <button id="sendOtpBtn" type="button" disabled>인증번호 전송</button>
      <div id="otpSection" style="display:none;">
        <label for="otpInput">인증번호 입력</label>
        <input type="text" id="otpInput" maxlength="6" placeholder="6자리 인증번호" autocomplete="one-time-code" />
        <button id="verifyOtpBtn" type="button" disabled>인증번호 확인</button>
      </div>
      <div id="authMessage" class="message"></div>
    </div>

    <label for="feedbackTextarea">의견 내용</label>
    <textarea id="feedbackTextarea" placeholder="의견을 작성해주세요." disabled></textarea>

    <button id="submitFeedbackBtn" type="button" disabled>전송하기</button>
    <div id="submitMessage" class="message"></div>
  </div>
</div>

<!-- EmailJS SDK -->
<script src="https://cdn.emailjs.com/sdk/3.12/email.min.js"></script>

<script>
  // EmailJS 초기화
  emailjs.init('cEMhcSRW87GAAMaL7');

  // DOM 요소
  const consentScreen = document.getElementById('consentScreen');
  const consentBtn = document.getElementById('consentBtn');
  const mainContent = document.getElementById('mainContent');
  const feedbackModal = document.getElementById('feedbackModal');
  const openFeedbackBtn = document.getElementById('openFeedbackBtn');

  const emailInput = document.getElementById('emailInput');
  const sendOtpBtn = document.getElementById('sendOtpBtn');
  const otpSection = document.getElementById('otpSection');
  const otpInput = document.getElementById('otpInput');
  const verifyOtpBtn = document.getElementById('verifyOtpBtn');
  const authMessage = document.getElementById('authMessage');

  const feedbackTextarea = document.getElementById('feedbackTextarea');
  const submitFeedbackBtn = document.getElementById('submitFeedbackBtn');
  const submitMessage = document.getElementById('submitMessage');

  // 동의 후 메인 화면 보이기
  consentBtn.addEventListener('click', () => {
    consentScreen.style.display = 'none';
    mainContent.style.display = 'block';
    document.body.style.overflow = 'auto'; // 스크롤 허용
  });

  // 모달 열기
  openFeedbackBtn.addEventListener('click', () => {
    feedbackModal.style.display = 'flex';
    // 모달 열 때 body 스크롤 차단
    document.body.style.overflow = 'hidden';
    resetModal();
  });

  // 이메일 입력 유효성 검사 (간단히)
  function validateEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  // OTP 생성 함수 (6자리 숫자)
  function generateOTP() {
    return Math.floor(100000 + Math.random() * 900000).toString();
  }

  // 전역 변수 OTP 저장
  let currentOTP = null;
  let isEmailVerified = false;

  // 이메일 입력시 인증번호 전송 버튼 활성화
  emailInput.addEventListener('input', () => {
    sendOtpBtn.disabled = !validateEmail(emailInput.value);
    authMessage.textContent = '';
    otpSection.style.display = 'none';
    otpInput.value = '';
    verifyOtpBtn.disabled = true;
    feedbackTextarea.disabled = true;
    submitFeedbackBtn.disabled = true;
    isEmailVerified = false;
  });

  // 인증번호 전송 버튼 클릭
  sendOtpBtn.addEventListener('click', () => {
    currentOTP = generateOTP();
    // EmailJS로 OTP 전송
    emailjs.send('service_x70u0xh', 'template_62q5w2q', {
      to_email: emailInput.value,
      otp_code: currentOTP
    })
    .then(() => {
      authMessage.textContent = '인증번호가 이메일로 전송되었습니다.';
      authMessage.className = 'message success';
      otpSection.style.display = 'block';
      verifyOtpBtn.disabled = true;
    }, (error) => {
      authMessage.textContent = '인증번호 전송에 실패했습니다. 다시 시도해주세요.';
      authMessage.className = 'message error';
      console.error('EmailJS 전송 오류:', error);
    });
  });

  // OTP 입력시 확인 버튼 활성화
  otpInput.addEventListener('input', () => {
    verifyOtpBtn.disabled = otpInput.value.length !== 6;
    authMessage.textContent = '';
  });

  // 인증번호 확인 버튼 클릭
  verifyOtpBtn.addEventListener('click', () => {
    if (otpInput.value === currentOTP) {
      isEmailVerified = true;
      authMessage.textContent = '이메일 인증이 완료되었습니다.';
      authMessage.className = 'message success';
      feedbackTextarea.disabled = false;
      submitFeedbackBtn.disabled = false;
      // OTP 입력 영역 숨기기 (선택사항)
      otpSection.style.display = 'none';
      sendOtpBtn.disabled = true;
      emailInput.disabled = true;
    } else {
      authMessage.textContent = '인증번호가 일치하지 않습니다.';
      authMessage.className = 'message error';
    }
  });

  // 의견 전송
  submitFeedbackBtn.addEventListener('click', () => {
    if (!isEmailVerified) {
      submitMessage.textContent = '이메일 인증 후 전송할 수 있습니다.';
      submitMessage.className = 'message error';
      return;
    }
    const feedbackText = feedbackTextarea.value.trim();
    if (feedbackText.length === 0) {
      submitMessage.textContent = '의견 내용을 입력해주세요.';
      submitMessage.className = 'message error';
      return;
    }

    submitFeedbackBtn.disabled = true;
    submitMessage.textContent = '전송 중...';
    submitMessage.className = '';

    emailjs.send('service_x70u0xh', 'template_62q5w2q', {
      to_email: emailInput.value,
      feedback_content: feedbackText
    })
    .then(() => {
      submitMessage.textContent = '의견이 성공적으로 전송되었습니다. 감사합니다.';
      submitMessage.className = 'message success';
      feedbackTextarea.value = '';
      resetModalAfterSuccess();
    }, (error) => {
      submitMessage.textContent = '전송 실패했습니다. 다시 시도해주세요.';
      submitMessage.className = 'message error';
      submitFeedbackBtn.disabled = false;
      console.error('EmailJS 전송 오류:', error);
    });
  });

  // 모달 초기화 함수
  function resetModal() {
    emailInput.value = '';
    emailInput.disabled = false;
    sendOtpBtn.disabled = true;

    otpInput.value = '';
    otpInput.disabled = false;
    verifyOtpBtn.disabled = true;
    otpSection.style.display = 'none';

    authMessage.textContent = '';
    authMessage.className = '';

    feedbackTextarea.value = '';
    feedbackTextarea.disabled = true;

    submitFeedbackBtn.disabled = true;
    submitMessage.textContent = '';

    currentOTP = null;
    isEmailVerified = false;
  }

  // 성공 후 초기화 및 모달 닫기 (선택사항)
  function resetModalAfterSuccess() {
    setTimeout(() => {
      feedbackModal.style.display = 'none';
      document.body.style.overflow = 'auto'; // 스크롤 복구
    }, 2500);
  }

</script>

</body>
</html>
