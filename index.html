<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>개꿀팁 - 의견센터 이메일 인증</title>
  <script type="module" src="https://cdn.emailjs.com/sdk/3.12.0/email.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      overflow-x: hidden;
    }
    #consentScreen {
      position: fixed;
      z-index: 99999;
      background: white;
      color: black;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      overflow-y: auto;
      padding: 30px 20px;
      box-sizing: border-box;
    }
    #consentScreen p.notice {
      font-weight: bold;
      color: red;
      margin-bottom: 20px;
    }
    .consent-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: space-between; /* 왼쪽, 오른쪽 버튼 배치 */
      max-width: 400px;
    }
    .consent-buttons button {
      flex: 1;
      padding: 10px 18px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
      background-color: purple;
      color: white;
      cursor: pointer;
      margin: 0 5px;
      user-select: none;
    }
    #copyright {
      position: absolute;
      top: 10px;
      left: 15px;
      font-size: 12px;
      color: #666;
    }
    #lawModal {
      display: none;
      position: fixed;
      z-index: 100000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    #lawModal .modal-law-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      margin: 100px auto;
      position: relative;
      white-space: pre-wrap;
      max-height: 80vh;
      overflow-y: auto;

      /* 스크롤바 스타일 */
      scrollbar-width: thin;        /* Firefox */
      scrollbar-color: #555 #ddd;   /* Firefox */
    }
    /* Chrome, Edge, Safari 스크롤바 */
    #lawModal .modal-law-content::-webkit-scrollbar {
      width: 12px;      /* 두껍게 조정 */
    }
    #lawModal .modal-law-content::-webkit-scrollbar-track {
      background: #ddd;
      border-radius: 6px;
    }
    #lawModal .modal-law-content::-webkit-scrollbar-thumb {
      background-color: #555;
      border-radius: 6px;
      border: 3px solid #ddd;
    }

    #lawModal .close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      user-select: none;
    }
    #mainApp {
      display: none;
      padding: 20px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    #searchInput {
      flex-grow: 1;
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-right: 15px;
    }
    .help-box {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      user-select: none;
    }
    .help-icon {
      width: 35px;
      height: 35px;
    }
    .container {
      min-height: 300px;
    }
    .product-box {
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
    }
    .product-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .product-number {
      font-weight: bold;
      font-size: 18px;
      color: purple;
      width: 30px;
    }
    .product-box img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 5px;
    }
    .title {
      font-size: 16px;
      flex-grow: 1;
    }
    a.product-link {
      text-decoration: none;
      color: inherit;
      display: flex;
      width: 100%;
      align-items: center;
    }

    /* 모달 공통 */
    .modal-overlay {
      display: none;
      position: fixed;
      z-index: 100000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: white;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      margin: 100px auto;
      padding: 20px;
      position: relative;
      box-sizing: border-box;
      max-height: 80vh;
      overflow-y: auto;
    }
    .close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      user-select: none;
    }
    input, textarea, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 16px;
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-family: inherit;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    button {
      background-color: purple;
      color: white;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- 동의서 화면 -->
  <div id="consentScreen">
    <div id="copyright">© 2025 개꿀팁. 무단 복제 및 재배포 금지.</div>
    <p class="notice">※ 개꿀팁 기능을 이용하려면 아래 자세히 보기를 반드시 확인해 주세요.</p>
    <div class="consent-buttons">
      <button id="consentAgree">동의</button>
      <button id="showLawModal">자세히 보기</button>
    </div>
  </div>

  <!-- 법적 고지 모달 -->
  <div id="lawModal">
    <div class="modal-law-content">
      <span class="close-button" id="closeLawModal">×</span>
      <strong>[의견 제출 기능 이용에 대한 고지 및 법적 동의서]</strong>

      본 웹페이지의 의견 제출 기능은 외부 메일 처리 서비스(Formspree.io)의 송신 인터페이스를 기반으로 운영되며, 사용자가 입력한 이메일 주소 및 의견 내용은 운영자에게 직접 전달됩니다.

      이에 따라 사용자는 의견 제출 이전에 다음 사항을 충분히 숙지하고, 이에 전적으로 동의한 것으로 간주됩니다.

      1. 본 페이지 내 스크립트에 포함된 Formspree 메일 송신 경로 또는 링크를 임의로 열람·조작하거나, 타인의 메일 주소를 무단으로 도용하여 메시지를 전송하는 행위는 부정 접속 및 기능 변조로 간주될 수 있습니다.

      2. 수신자 이메일 주소를 대상으로 욕설, 도배, 광고, 비방, 모욕, 성적 표현, 협박 등 사회적으로 부적절하거나 법률 위반 소지가 있는 내용을 반복적으로 전송할 경우, 「형법」 및 「정보통신망법」 등에 따라 민·형사상 법적 책임이 발생할 수 있습니다.

      3. 본 시스템은 서버 로그를 수집하거나 IP 정보를 기록하지 않지만, 전송된 메시지 및 메일 수신 시점 등의 기록은 보존될 수 있으며, 운영자 판단에 따라 법적 조치를 요청할 수 있습니다.

      사용자는 위 사항을 충분히 이해하였으며, 이에 전적으로 동의합니다.
    </div>
  </div>

  <!-- 메인 앱 -->
  <div id="mainApp">
    <div class="top-bar">
      <input type="text" id="searchInput" placeholder="숫자를 검색하세요 (예: 1)" />
      <div class="help-box" id="openModal">
        <img
          src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSoYnzdTBQO1svckSLMMg75P7ZQ51xkkMyccbffdrJ2&s"
          alt="고객센터"
          class="help-icon"
        />
        <div class="label">의견센터</div>
      </div>
    </div>

    <div class="container" id="results"></div>
  </div>

  <!-- 의견 모달 -->
  <div id="feedbackModal" class="modal-overlay">
    <div class="modal-content">
      <span id="closeModal" class="close-button">×</span>
      <form id="feedbackForm">
        <input
          type="email"
          id="userEmail"
          name="user_email"
          placeholder="이메일 주소를 입력하세요"
          required
        />
        <textarea
          id="userMessage"
          name="message"
          placeholder="의견 사항을 입력해주세요..."
          required
        ></textarea>
        <button type="submit">보내기</button>
      </form>
    </div>
  </div>

  <!-- 인증번호 입력 모달 -->
  <div id="otpModal" class="modal-overlay">
    <div class="modal-content">
      <span id="closeOtpModal" class="close-button">×</span>
      <p>이메일로 전송된 6자리 인증번호를 입력하세요.</p>
      <input type="text" id="otpInput" placeholder="인증번호 입력" maxlength="6" />
      <button id="verifyOtpBtn">인증하고 전송</button>
    </div>
  </div>

  <script type="module">
    import emailjs from "https://cdn.emailjs.com/sdk/3.12.0/email.min.js";

    emailjs.init("public_cEMhcSRW87GAAMaL7");

    document.getElementById("consentAgree").addEventListener("click", () => {
      document.getElementById("consentScreen").style.display = "none";
      document.getElementById("mainApp").style.display = "block";
    });

    document.getElementById("showLawModal").addEventListener("click", () => {
      document.getElementById("lawModal").style.display = "block";
    });
    document.getElementById("closeLawModal").addEventListener("click", () => {
      document.getElementById("lawModal").style.display = "none";
    });

    document.getElementById("openModal").addEventListener("click", () => {
      document.getElementById("openModal").addEventListener("click", () => {
  document.getElementById("feedbackModal").style.display = "block";
});

document.getElementById("closeModal").addEventListener("click", () => {
  document.getElementById("feedbackModal").style.display = "none";
});

document.getElementById("closeOtpModal").addEventListener("click", () => {
  document.getElementById("otpModal").style.display = "none";
});

window.addEventListener("click", (e) => {
  const feedbackModal = document.getElementById("feedbackModal");
  const otpModal = document.getElementById("otpModal");
  const lawModal = document.getElementById("lawModal");
  if (e.target === feedbackModal) feedbackModal.style.display = "none";
  if (e.target === otpModal) otpModal.style.display = "none";
  if (e.target === lawModal) lawModal.style.display = "none";
});

// 이메일 인증번호 생성 함수
function generateOTP(length = 6) {
  let otp = "";
  for (let i = 0; i < length; i++) {
    otp += Math.floor(Math.random() * 10);
  }
  return otp;
}

let currentOTP = "";
let pendingForm = null;

// 1. 의견 보내기 눌렀을 때: 인증번호 발송 후 OTP 모달 띄우기
document.getElementById("feedbackForm").addEventListener("submit", function (e) {
  e.preventDefault();

  // 이메일, 메시지 값 확인
  const email = this.user_email.value.trim();
  const message = this.message.value.trim();
  if (!email || !message) {
    alert("이메일과 의견 내용을 모두 입력해주세요.");
    return;
  }

  // OTP 생성
  currentOTP = generateOTP();

  // 이메일로 OTP 전송 (emailjs 사용)
  // 여기서 OTP 전송용 템플릿 아이디 따로 만들어야 함.
  emailjs.send("service_x70u0xh", "template_otp_send", {
    to_email: email,
    otp_code: currentOTP,
  }).then(() => {
    alert("인증번호가 이메일로 전송되었습니다. 메일함을 확인해주세요.");
    document.getElementById("feedbackModal").style.display = "none";
    document.getElementById("otpModal").style.display = "block";
    pendingForm = this; // 제출 보류 폼 저장
  }).catch((error) => {
    alert("인증번호 전송 실패: " + JSON.stringify(error));
  });
});

// 2. OTP 확인 후 진짜 의견 전송
document.getElementById("verifyOtpBtn").addEventListener("click", () => {
  const inputOtp = document.getElementById("otpInput").value.trim();

  if (inputOtp.length !== 6) {
    alert("6자리 인증번호를 정확히 입력해주세요.");
    return;
  }

  if (inputOtp !== currentOTP) {
    alert("인증번호가 일치하지 않습니다. 다시 확인해주세요.");
    return;
  }

  // OTP 일치 -> 실제 의견 전송
  if (!pendingForm) {
    alert("폼 데이터가 없습니다. 다시 시도해주세요.");
    return;
  }

  emailjs.sendForm("service_x70u0xh", "template_62q5w2q", pendingForm)
    .then(() => {
      alert("성공적으로 의견이 전송되었습니다!");
      pendingForm.reset();
      currentOTP = "";
      pendingForm = null;
      document.getElementById("otpInput").value = "";
      document.getElementById("otpModal").style.display = "none";
    })
    .catch((error) => {
      alert("의견 전송 실패: " + JSON.stringify(error));
    });
});
